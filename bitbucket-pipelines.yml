image: atlassian/default-image:3

definitions:
  caches:
    phpstan: build/phpstan
  setupScript: &setupScript |
    cp .env.example .env \
    docker compose up -d \
    docker compose exec laravel.test composer i --prefer-dist --no-interaction \
    docker compose exec laravel.test php artisan key:generate
  steps:
    - step: &common-step
        caches:
          - docker
    - step: &check-format
        <<: *common-step
        name: Check Format
        script:
          - *setupScript
          - docker compose exec laravel.test composer format-dry-run
        condition:
          changesets:
            includePaths:
              - "**.php"
              - "pint.json"
    - step: &analyse
        <<: *common-step
        name: Analyse
        script:
          - *setupScript
          - docker compose exec laravel.test composer analyse -- --memory-limit 256M
        caches:
          - docker
          - phpstan
        condition:
          changesets:
            includePaths:
              - "**.php"
              - "phpstan.neon.dist"
    - step: &test
        <<: *common-step
        name: Test
        script:
          - *setupScript
          - docker compose exec laravel.test composer test

options:
  docker: true

pipelines:
  branches:
    master:
      - parallel:
          - step: *check-format
          - step: *analyse
          - step: *test

  pull-requests:
    "**":
      - parallel:
          - step: *check-format
          - step: *analyse
          - step: *test
